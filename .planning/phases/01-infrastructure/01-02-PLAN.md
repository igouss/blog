---
phase: 01-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - /etc/caddy/Caddyfile
autonomous: true
requirements:
  - INFRA-03

must_haves:
  truths:
    - "/etc/caddy/Caddyfile is a symlink pointing to /srv/blog/configs/Caddyfile"
    - "Caddy service is enabled and running"
    - "Caddy serves HTTPS on port 443 with a valid *.ts.net certificate (no browser TLS warning)"
    - "https://fedora.mist-walleye.ts.net is reachable from within the tailnet and returns HTTP 200"
  artifacts:
    - path: "/etc/caddy/Caddyfile"
      provides: "Symlink to /srv/blog/configs/Caddyfile (Caddy reads config here)"
  key_links:
    - from: "/etc/caddy/Caddyfile"
      to: "/srv/blog/configs/Caddyfile"
      via: "symlink"
      pattern: "Caddyfile -> /srv/blog/configs/Caddyfile"
    - from: "Caddy TLS"
      to: "tailscaled cert socket"
      via: "get_certificate tailscale directive"
      pattern: "get_certificate tailscale"
---

<objective>
Deploy the Caddyfile and bring Caddy up serving HTTPS with the Tailscale-issued *.ts.net certificate.

Purpose: This is the core TLS + file serving step. After this plan succeeds, the blog is reachable over HTTPS within the tailnet. Plan 03 then exposes it to the public internet via Funnel.

Output: /etc/caddy/Caddyfile symlink to /srv/blog/configs/Caddyfile; caddy.service enabled and active; HTTPS on port 443 with valid *.ts.net cert.
</objective>

<execution_context>
@/home/elendal/.claude/get-shit-done/workflows/execute-plan.md
@/home/elendal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Symlink Caddyfile and enable Caddy</name>
  <files>/etc/caddy/Caddyfile</files>
  <action>
Create the symlink from /etc/caddy/Caddyfile to /srv/blog/configs/Caddyfile so the COPR caddy.service picks up the config. Using a symlink (not a copy) keeps /srv/blog/configs/Caddyfile as the single source of truth.

```bash
# Symlink: source of truth at /srv/blog/configs/Caddyfile
sudo ln -sf /srv/blog/configs/Caddyfile /etc/caddy/Caddyfile

# Verify the symlink points correctly
ls -la /etc/caddy/Caddyfile
# Expected: /etc/caddy/Caddyfile -> /srv/blog/configs/Caddyfile

# Enable and start Caddy
sudo systemctl enable --now caddy
```

IMPORTANT: tailscaled must already be restarted with TS_PERMIT_CERT_UID=caddy (done in Plan 01) before this step. If that was not done, Caddy will fail to obtain the TLS cert and either error out or use a self-signed fallback. Verify Plan 01 is complete before proceeding.

The COPR caddy.service already has:
- User=caddy (runs as caddy user)
- AmbientCapabilities=CAP_NET_BIND_SERVICE (allows binding port 443 as non-root)
- ExecStart reads /etc/caddy/Caddyfile by default
No custom unit file modifications are needed.
  </action>
  <verify>
```bash
ls -la /etc/caddy/Caddyfile
# Expected: lrwxrwxrwx ... /etc/caddy/Caddyfile -> /srv/blog/configs/Caddyfile

sudo systemctl is-active caddy
# Expected: active

sudo systemctl is-enabled caddy
# Expected: enabled
```
  </verify>
  <done>/etc/caddy/Caddyfile is a symlink to /srv/blog/configs/Caddyfile; caddy.service is active and enabled.</done>
</task>

<task type="auto">
  <name>Task 2: Verify HTTPS with Tailscale TLS cert</name>
  <files></files>
  <action>
Confirm Caddy obtained the *.ts.net cert from tailscaled and is serving HTTPS correctly. Run these checks from the Fedora host itself (tailnet access):

```bash
# Check Caddy logs for cert fetch â€” look for success, not errors
journalctl -u caddy -n 50 --no-pager
# Look for: "certificate obtained" or "serving" or similar success lines
# Red flags: "failed to get certificate", "permission denied on socket", "bind: address already in use"

# Verify Caddy is listening on 443
sudo ss -tlnp | grep ':443'
# Expected: LISTEN 0.0.0.0:443 or :::443 with caddy or pid visible

# Test HTTPS response from within the tailnet
curl -sv https://fedora.mist-walleye.ts.net 2>&1 | grep -E "< HTTP|subject|issuer|SSL connection"
# Expected:
#   SSL connection using TLSv1.3 (or TLSv1.2)
#   subject: *.mist-walleye.ts.net (or fedora.mist-walleye.ts.net)
#   issuer: Tailscale (or similar)
#   < HTTP/2 200
```

If Caddy log shows cert fetch errors:
1. Confirm tailscaled is running: `sudo systemctl is-active tailscaled`
2. Confirm env var is in effect: `grep TS_PERMIT_CERT_UID /etc/default/tailscaled`
3. If env var was added after tailscaled was last started, restart tailscaled again: `sudo systemctl restart tailscaled`
4. Then restart Caddy: `sudo systemctl restart caddy`

If port 443 is already in use by another process, identify and stop it: `sudo ss -tlnp | grep ':443'`
  </action>
  <verify>
```bash
# No TLS errors in Caddy logs
journalctl -u caddy -n 20 --no-pager | grep -v -i "error\|fail\|denied"
# (or confirm no error lines exist)

# HTTP 200 from tailnet
curl -o /dev/null -s -w "%{http_code}" https://fedora.mist-walleye.ts.net
# Expected: 200

# Certificate is from Tailscale, not self-signed
curl -sv https://fedora.mist-walleye.ts.net 2>&1 | grep -i "issuer\|subject"
# Expected: subject contains mist-walleye.ts.net; no "CERTIFICATE_VERIFY_FAILED"
```
  </verify>
  <done>curl https://fedora.mist-walleye.ts.net returns HTTP 200 from within the tailnet; TLS certificate is Tailscale-issued (*.ts.net), not self-signed; Caddy logs show no cert-fetch errors.</done>
</task>

</tasks>

<verification>
After both tasks:

```bash
# Symlink correct
readlink /etc/caddy/Caddyfile
# Expected: /srv/blog/configs/Caddyfile

# Caddy running
sudo systemctl status caddy --no-pager | head -5

# HTTPS 200 from tailnet
curl -o /dev/null -s -w "%{http_code}\n" https://fedora.mist-walleye.ts.net
# Expected: 200

# No errors in caddy logs
journalctl -u caddy -n 30 --no-pager | grep -iE "error|fail|denied" || echo "No errors found"
```
</verification>

<success_criteria>
- /etc/caddy/Caddyfile symlinks to /srv/blog/configs/Caddyfile
- caddy.service is active and enabled
- https://fedora.mist-walleye.ts.net returns HTTP 200 from within the tailnet
- TLS cert is Tailscale-issued *.ts.net (no browser TLS warning, no CERTIFICATE_VERIFY_FAILED)
- No cert-fetch errors in Caddy logs
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-02-SUMMARY.md` with the symlink path, Caddy status, and curl output confirming HTTP 200 + TLS cert details.
</output>
