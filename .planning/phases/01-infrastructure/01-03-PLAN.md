---
phase: 01-infrastructure
plan: 03
type: execute
wave: 3
depends_on:
  - "01-02"
files_modified: []
autonomous: false
requirements:
  - INFRA-04
  - INFRA-05

must_haves:
  truths:
    - "tailscale funnel is active in --https=443 mode routing public internet traffic to http://localhost:8080"
    - "A browser or curl from outside the tailnet receives HTTP 200 over HTTPS from fedora.mist-walleye.ts.net"
    - "TLS certificate is valid — no browser warning — when accessed from outside the tailnet"
  artifacts:
    - path: "tailscale funnel status"
      provides: "Persistent Funnel rule: port 443 (HTTPS) → http://localhost:8080"
  key_links:
    - from: "public internet"
      to: "tailscaled on fedora.mist-walleye.ts.net"
      via: "Tailscale Funnel (--https=443 mode, Funnel terminates TLS)"
      pattern: "tailscale funnel --https=443 http://localhost:8080"
    - from: "tailscaled"
      to: "Caddy on localhost:8080"
      via: "plain HTTP proxy"
      pattern: "http://localhost:8080"

user_setup:
  - service: tailscale-admin-console
    why: "Tailscale Funnel requires nodeAttrs funnel in the tailnet ACL policy. If not already enabled, the tailscale funnel command will prompt for admin console action."
    dashboard_config:
      - task: "Enable Funnel in tailnet ACL policy"
        location: "Tailscale admin console → Access controls → Edit policy — add: {\"nodeAttrs\": [{\"target\": [\"autogroup:member\"], \"attr\": [\"funnel\"]}]}"
---

<objective>
Expose the blog to the public internet via Tailscale Funnel (--https=443 mode) and verify end-to-end HTTPS access from outside the tailnet.

Purpose: This is the final Phase 1 milestone. Funnel in --https=443 mode terminates TLS itself and forwards plain HTTP to Caddy on localhost:8080. Caddy needs no cert and no special port — it just serves files over HTTP locally.

Output: Active Funnel rule persisting across reboots; confirmed HTTP 200 from external device over HTTPS.
</objective>

<execution_context>
@/home/elendal/.claude/get-shit-done/workflows/execute-plan.md
@/home/elendal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable Tailscale Funnel on port 443</name>
  <files></files>
  <action>
Enable Tailscale Funnel to forward public internet HTTPS traffic to Caddy on localhost:8080.

```bash
# --bg: persist across reboots and terminal exit
# --https=443: Funnel terminates TLS, forwards plain HTTP to Caddy
tailscale funnel --bg --https=443 http://localhost:8080
```

Using `--https=443` (not `--tls-terminated-tcp`) because Caddy serves plain HTTP — Funnel handles the TLS certificate for fedora.mist-walleye.ts.net.

If the command outputs a link to the Tailscale admin console, the tailnet ACL policy is missing the `funnel` nodeAttr:
1. Go to the admin console URL provided
2. Edit the policy JSON to add: `{"nodeAttrs": [{"target": ["autogroup:member"], "attr": ["funnel"]}]}`
3. Save the policy
4. Re-run the `tailscale funnel` command

After enabling, verify the Funnel rule is active:
```bash
tailscale funnel status
# Expected: shows fedora.mist-walleye.ts.net port 443 → http://localhost:8080
```

Source: https://tailscale.com/kb/1311/tailscale-funnel
  </action>
  <verify>
```bash
tailscale funnel status
# Expected: shows an active rule for port 443 forwarding to http://localhost:8080
```
  </verify>
  <done>tailscale funnel status shows an active rule: fedora.mist-walleye.ts.net port 443 → http://localhost:8080.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify external HTTPS access from outside the tailnet</name>
  <files></files>
  <action>
What was built: Tailscale Funnel is active (--https=443 → localhost:8080). Caddy is serving plain HTTP on :8080. The full stack should now be publicly reachable over HTTPS.

From a device OUTSIDE the tailnet (mobile phone on cellular data, a VPS, or any device not on mist-walleye tailnet):

1. Open a browser and navigate to: https://fedora.mist-walleye.ts.net
   - Expected: Page loads with "Blog coming soon" — no TLS warning, no connection refused

2. OR run curl from an external device:
   ```
   curl -I https://fedora.mist-walleye.ts.net
   ```
   Expected:
   ```
   HTTP/2 200
   ```

If this fails:
- Confirm Funnel is active: `tailscale funnel status`
- Confirm Caddy is running: `pgrep -a caddy`
- Confirm Caddy returns 200 locally: `curl -s -o /dev/null -w "%{http_code}" http://localhost:8080`
- If Caddy stopped: `caddy start --config /home/elendal/IdeaProjects/blog/configs/Caddyfile`
  </action>
  <verify>
Human confirms: https://fedora.mist-walleye.ts.net loads from outside the tailnet with no TLS warning and returns HTTP 200.

Resume signal: Type "approved" if https://fedora.mist-walleye.ts.net loads correctly from outside the tailnet. Describe any issues if it does not.
  </verify>
  <done>User confirms external HTTPS access — browser or curl from outside the tailnet receives HTTP 200 with no TLS warning.</done>
</task>

</tasks>

<verification>
After human confirmation:

```bash
# Funnel persists
tailscale funnel status

# Caddy still running
pgrep -a caddy

# Local smoke test
curl -o /dev/null -s -w "%{http_code}\n" http://localhost:8080
# Expected: 200
```

All four Phase 1 success criteria should now be met:
1. Repository directory structure exists in /home/elendal/IdeaProjects/blog
2. HTTPS works end-to-end — Funnel provides valid TLS cert (no browser warning)
3. Tailscale Funnel is active and routing public internet traffic on port 443
4. External browser receives HTTP 200 over HTTPS
</verification>

<success_criteria>
- tailscale funnel status shows active rule for port 443 → http://localhost:8080
- https://fedora.mist-walleye.ts.net returns HTTP 200 from a device outside the tailnet
- No TLS warning in browser — Tailscale-issued cert
- User has confirmed external access via the checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-03-SUMMARY.md` with the funnel status output, the external verification result, and confirmation of all four Phase 1 success criteria.
</output>
