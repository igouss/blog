---
phase: 01-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/elendal/IdeaProjects/blog/configs/Caddyfile
  - /home/elendal/IdeaProjects/blog/index.html
  - /etc/default/tailscaled
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02

must_haves:
  truths:
    - "Blog repo has articles/, templates/, css/, scripts/, configs/ subdirectories"
    - "caddy user can read /home/elendal/IdeaProjects/blog (world-readable permissions)"
    - "TS_PERMIT_CERT_UID=caddy is set in /etc/default/tailscaled"
    - "tailscaled is running with the updated env var in effect"
  artifacts:
    - path: "/home/elendal/IdeaProjects/blog/configs/Caddyfile"
      provides: "Phase 1 minimal Caddyfile (source of truth)"
    - path: "/home/elendal/IdeaProjects/blog/index.html"
      provides: "Placeholder HTML for pipeline validation"
    - path: "/etc/default/tailscaled"
      provides: "tailscaled env config granting Caddy TLS cert access"
  key_links:
    - from: "/etc/default/tailscaled"
      to: "tailscaled TLS cert socket"
      via: "TS_PERMIT_CERT_UID=caddy env var"
      pattern: "TS_PERMIT_CERT_UID=caddy"
    - from: "/home/elendal/IdeaProjects/blog"
      to: "caddy process"
      via: "world-readable permissions (755/644)"
      pattern: "chmod -R a+rX /home/elendal/IdeaProjects/blog"
---

<objective>
Create the blog directory layout inside the git repo and grant Caddy permission to fetch TLS certs from tailscaled.

Purpose: These are the two prerequisites everything else in Phase 1 depends on. The directory tree must exist before Caddy can serve files. The TS_PERMIT_CERT_UID must be in effect before Caddy starts — if tailscaled is not restarted with this var, Caddy will fail to obtain the *.ts.net certificate.

Output: Blog repo subdirs created, world-readable so Caddy can serve them; configs/Caddyfile (source of truth); index.html placeholder; /etc/default/tailscaled updated; tailscaled restarted.

Note on SELinux: /home has user_home_t context by default. We skip preemptive SELinux relabeling and try as-is first. If Caddy returns 403, the fix is: sudo semanage fcontext -a -t httpd_sys_content_t "/home/elendal/IdeaProjects/blog(/.*)?" && sudo restorecon -Rv /home/elendal/IdeaProjects/blog
</objective>

<execution_context>
@/home/elendal/.claude/get-shit-done/workflows/execute-plan.md
@/home/elendal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blog subdirectory layout and make world-readable</name>
  <files>articles/ templates/ css/ scripts/ configs/ index.html</files>
  <action>
The repo already exists at /home/elendal/IdeaProjects/blog. Just create the subdirs and placeholder:

```bash
cd /home/elendal/IdeaProjects/blog
mkdir -p articles templates css scripts configs

# Placeholder HTML for pipeline validation
cat > index.html <<'EOF'
<!DOCTYPE html>
<html><head><title>Blog</title></head>
<body><h1>Blog coming soon</h1></body>
</html>
EOF

# Make world-readable so Caddy (running as caddy user) can read without ownership
chmod -R a+rX /home/elendal/IdeaProjects/blog
```

Rationale for world-readable: files are owned by elendal (no sudo needed to edit content). `a+rX` sets read on files and execute on dirs for all users — caddy reads, elendal writes.

Note: if Caddy returns 403 after starting, SELinux is blocking access. Fix: `sudo semanage fcontext -a -t httpd_sys_content_t "/home/elendal/IdeaProjects/blog(/.*)?" && sudo restorecon -Rv /home/elendal/IdeaProjects/blog`
  </action>
  <verify>
```bash
ls /home/elendal/IdeaProjects/blog/{articles,templates,css,scripts,configs}
# Expected: directories exist (empty is fine)

stat -c "%U:%G %a %n" /home/elendal/IdeaProjects/blog /home/elendal/IdeaProjects/blog/articles /home/elendal/IdeaProjects/blog/index.html
# Expected: elendal:elendal, dirs 755, files 644

cat /home/elendal/IdeaProjects/blog/index.html
# Expected: Blog coming soon HTML
```
  </verify>
  <done>All five subdirectories and index.html exist in the blog repo; owned elendal:elendal; world-readable.</done>
</task>

<task type="auto">
  <name>Task 2: Write Phase 1 Caddyfile into configs/</name>
  <files>configs/Caddyfile</files>
  <action>
Write the minimal Phase 1 Caddyfile. This is the source-of-truth config that will be symlinked to /etc/caddy/Caddyfile in Plan 02.

Phase 1 only needs HTTPS + static file serving. Do NOT add template, rewrite, or content-negotiation directives — those are Phase 2.

```bash
cat > /home/elendal/IdeaProjects/blog/configs/Caddyfile <<'EOF'
fedora.mist-walleye.ts.net {
    root * /home/elendal/IdeaProjects/blog

    file_server

    tls {
        get_certificate tailscale
    }
}
EOF
```

Site address MUST be `fedora.mist-walleye.ts.net` — not `blog.mist-walleye.ts.net` (no CNAME exists, locked decision).
  </action>
  <verify>
```bash
cat /home/elendal/IdeaProjects/blog/configs/Caddyfile
# Expected: fedora.mist-walleye.ts.net block with root pointing to /home/elendal/IdeaProjects/blog, file_server, tls { get_certificate tailscale }
```
  </verify>
  <done>Caddyfile exists at configs/Caddyfile with fedora.mist-walleye.ts.net site block, correct root path, file_server, and get_certificate tailscale.</done>
</task>

<task type="auto">
  <name>Task 3: Set TS_PERMIT_CERT_UID and restart tailscaled</name>
  <files>/etc/default/tailscaled</files>
  <action>
Grant the caddy user permission to fetch TLS certs from tailscaled. This MUST be done and tailscaled MUST be restarted BEFORE Caddy is started — if the order is reversed, Caddy fails to obtain the *.ts.net certificate.

Check idempotently to avoid duplicate entries:
```bash
grep -q 'TS_PERMIT_CERT_UID=caddy' /etc/default/tailscaled 2>/dev/null \
  && echo "Already set — no change needed" \
  || { echo 'TS_PERMIT_CERT_UID=caddy' | sudo tee -a /etc/default/tailscaled && echo "Added TS_PERMIT_CERT_UID=caddy"; }
```

Then restart tailscaled:
```bash
sudo systemctl restart tailscaled
sudo systemctl is-active tailscaled
```

Source: https://tailscale.com/kb/1190/caddy-certificates
  </action>
  <verify>
```bash
grep 'TS_PERMIT_CERT_UID=caddy' /etc/default/tailscaled
# Expected: TS_PERMIT_CERT_UID=caddy (exactly one occurrence)

sudo systemctl is-active tailscaled
# Expected: active
```
  </verify>
  <done>TS_PERMIT_CERT_UID=caddy appears exactly once in /etc/default/tailscaled; tailscaled is active.</done>
</task>

</tasks>

<verification>
After all three tasks, confirm the host is ready for Plan 02:

```bash
# 1. Subdirectory tree exists
ls /home/elendal/IdeaProjects/blog/{articles,templates,css,scripts,configs}

# 2. Placeholder content in place
cat /home/elendal/IdeaProjects/blog/index.html

# 3. Caddyfile is ready with correct root path
grep 'fedora.mist-walleye.ts.net' /home/elendal/IdeaProjects/blog/configs/Caddyfile
grep '/home/elendal/IdeaProjects/blog' /home/elendal/IdeaProjects/blog/configs/Caddyfile

# 4. tailscaled env var in place and process running
grep 'TS_PERMIT_CERT_UID=caddy' /etc/default/tailscaled
sudo systemctl is-active tailscaled
```
</verification>

<success_criteria>
- articles/, templates/, css/, scripts/, configs/ exist in blog repo, world-readable
- index.html exists with placeholder HTML content, owned elendal:elendal
- configs/Caddyfile exists with fedora.mist-walleye.ts.net block, root pointing to /home/elendal/IdeaProjects/blog
- /etc/default/tailscaled contains TS_PERMIT_CERT_UID=caddy
- tailscaled is active (systemd)
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-01-SUMMARY.md` with files created, commands run, and any issues encountered.
</output>
