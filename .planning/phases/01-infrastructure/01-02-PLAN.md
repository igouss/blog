---
phase: 01-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - configs/Caddyfile
autonomous: true
requirements:
  - INFRA-03

must_haves:
  truths:
    - "configs/Caddyfile serves plain HTTP on :8080 (no TLS — Tailscale Funnel handles TLS)"
    - "Caddy is running as elendal user (caddy start)"
    - "curl http://localhost:8080 returns HTTP 200"
  artifacts:
    - path: "configs/Caddyfile"
      provides: "Updated Caddyfile — plain HTTP on :8080, no TLS block"
  key_links:
    - from: "Tailscale Funnel (port 443, --https mode)"
      to: "Caddy on localhost:8080"
      via: "Funnel HTTP proxy (Funnel terminates TLS, forwards HTTP)"
      pattern: "tailscale funnel --https=443 http://localhost:8080"
---

<objective>
Reconfigure Caddyfile to plain HTTP on :8080 and start Caddy as the elendal user.

Purpose: With Tailscale Funnel using --https=443 mode, Funnel terminates TLS and proxies plain HTTP to Caddy. Caddy doesn't need a cert, doesn't need port 443, and doesn't need to run as a system service. No /etc/caddy/Caddyfile modification needed — Caddy reads directly from the repo.

Output: configs/Caddyfile updated to HTTP :8080; Caddy running as user; localhost:8080 returns HTTP 200.
</objective>

<execution_context>
@/home/elendal/.claude/get-shit-done/workflows/execute-plan.md
@/home/elendal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Caddyfile to plain HTTP on :8080</name>
  <files>configs/Caddyfile</files>
  <action>
Replace the existing Caddyfile with a plain HTTP config on :8080. Tailscale Funnel (Plan 03) will handle TLS — Caddy does not need a cert or port 443.

```bash
cat > /home/elendal/IdeaProjects/blog/configs/Caddyfile <<'EOF'
:8080 {
    root * /home/elendal/IdeaProjects/blog

    file_server
}
EOF
```

No `tls` block. No domain name in the site address (just port). Caddy binds on all interfaces on :8080; Funnel connects from localhost.
  </action>
  <verify>
```bash
cat /home/elendal/IdeaProjects/blog/configs/Caddyfile
# Expected: :8080 block with root and file_server, no tls block
```
  </verify>
  <done>configs/Caddyfile contains :8080 site block with file_server and no TLS.</done>
</task>

<task type="auto">
  <name>Task 2: Start Caddy as user and verify HTTP 200</name>
  <files></files>
  <action>
Start Caddy as a background process using `caddy start`. This daemonizes Caddy without systemd — it persists until `caddy stop` or reboot.

```bash
# Stop any existing caddy process first (idempotent)
caddy stop 2>/dev/null || true

# Start Caddy reading from the repo config
caddy start --config /home/elendal/IdeaProjects/blog/configs/Caddyfile

# Give it a moment to bind
sleep 2

# Verify it's listening
curl -s -o /dev/null -w "%{http_code}" http://localhost:8080
# Expected: 200
```

If port 8080 is already in use: `ss -tlnp | grep 8080` to identify the process.
  </action>
  <verify>
```bash
# Caddy process is running
pgrep -a caddy
# Expected: caddy process visible

# HTTP 200 on localhost
curl -s -o /dev/null -w "%{http_code}\n" http://localhost:8080
# Expected: 200

# Response contains placeholder HTML
curl -s http://localhost:8080 | grep "Blog coming soon"
# Expected: match
```
  </verify>
  <done>Caddy is running as elendal user; curl http://localhost:8080 returns HTTP 200 with "Blog coming soon" content.</done>
</task>

</tasks>

<verification>
```bash
# Caddy running
pgrep -a caddy

# HTTP 200
curl -s -o /dev/null -w "%{http_code}\n" http://localhost:8080

# Content correct
curl -s http://localhost:8080 | grep "Blog coming soon"
```
</verification>

<success_criteria>
- configs/Caddyfile has :8080 site block with file_server, no TLS
- Caddy is running as elendal user (caddy start)
- curl http://localhost:8080 returns HTTP 200 with placeholder HTML
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-02-SUMMARY.md` with the Caddyfile content, caddy start output, and curl verification result.
</output>
