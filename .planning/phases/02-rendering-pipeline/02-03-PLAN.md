---
phase: 02-rendering-pipeline
plan: "03"
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified: []
autonomous: false
requirements: [REND-01, REND-02, REND-03, REND-04, REND-05, REND-06, REND-07, STYL-04]

must_haves:
  truths:
    - "Browser request to an article URL receives rendered HTML with title and date from YAML front matter"
    - "curl -H 'Accept: text/markdown' returns raw Markdown with correct Content-Type"
    - "Responses include Vary: Accept header"
    - "Requesting a non-existent article returns HTTP 404 with HTML 404 page"
    - "Code blocks display with syntax highlighting"
    - "Direct requests to /templates/ return HTTP 403"
  artifacts:
    - path: "configs/Caddyfile"
      provides: "Phase 2 routing config"
    - path: "templates/article.html"
      provides: "Article rendering template"
    - path: "templates/404.html"
      provides: "404 error page template"
    - path: "css/syntax.css"
      provides: "Chroma syntax highlighting CSS"
  key_links:
    - from: "browser"
      to: "rendered HTML article"
      via: "Caddy rewrite → templates/article.html → Goldmark → HTML response"
      pattern: "<!DOCTYPE html>"
    - from: "curl -H Accept: text/markdown"
      to: "raw Markdown file"
      via: "Caddy @wantsMarkdown matcher → file_server"
      pattern: "text/markdown"
---

<objective>
Human verification of the complete Phase 2 rendering pipeline against all five Phase 2 success criteria.

Purpose: Confirms the full pipeline works end-to-end from the public URL before moving to Phase 3.
Output: User confirms all success criteria met; phase declared complete.
</objective>

<execution_context>
@/home/elendal/.claude/get-shit-done/workflows/execute-plan.md
@/home/elendal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verification article and run automated checks</name>
  <files>articles/test-pipeline.md</files>
  <action>
Create a temporary verification article and run all automated checks against localhost.

**Step 1: Create verification article**
```bash
cat > /home/elendal/IdeaProjects/blog/articles/test-pipeline.md << 'EOF'
---
title: Pipeline Verification
date: 2026-02-21
---

This article verifies the rendering pipeline.

## Code Block Test

```python
def greet(name: str) -> str:
    return f"Hello, {name}!"
```

End of verification.
EOF
chmod a+r /home/elendal/IdeaProjects/blog/articles/test-pipeline.md
```

**Step 2: Run all Phase 2 automated checks**

```bash
BASE="http://localhost:8080"

echo "=== SC1: HTML rendering with front matter ==="
curl -s "$BASE/articles/test-pipeline" | grep -E "<title>|<h1>|<time>"
# Expected lines containing: Pipeline Verification, 2026-02-21

echo "=== SC2: Markdown content negotiation ==="
curl -s -H "Accept: text/markdown" "$BASE/articles/test-pipeline" | head -5
# Expected: raw YAML front matter + Markdown content

echo "=== SC2: Content-Type header ==="
curl -s -I -H "Accept: text/markdown" "$BASE/articles/test-pipeline" | grep -i "content-type"
# Expected: text/markdown; charset=utf-8

echo "=== SC3: Vary: Accept header ==="
curl -s -I "$BASE/articles/test-pipeline" | grep -i "vary"
# Expected: Vary: Accept

echo "=== SC4: 404 for missing article ==="
curl -s -o /dev/null -w "%{http_code}" "$BASE/articles/does-not-exist"
# Expected: 404

curl -s "$BASE/articles/does-not-exist" | grep -i "back to articles"
# Expected: line with "Back to articles"

echo "=== SC5a: Syntax highlighting in code block ==="
curl -s "$BASE/articles/test-pipeline" | grep -c "chroma"
# Expected: > 0 (Chroma CSS classes in HTML)

echo "=== SC5b: /templates/ returns 403 ==="
curl -s -o /dev/null -w "%{http_code}" "$BASE/templates/"
# Expected: 403

echo "=== Additional: /configs/ returns 403 ==="
curl -s -o /dev/null -w "%{http_code}" "$BASE/configs/"
# Expected: 403

echo "=== Additional: /css/ is accessible ==="
curl -s -o /dev/null -w "%{http_code}" "$BASE/css/syntax.css"
# Expected: 200
```

Capture the full output. If any check fails, diagnose and fix before the checkpoint.

**Common fixes:**
- If `Vary: Accept` missing: check `header +Vary "Accept"` in Caddyfile; reload with `caddy reload --config configs/Caddyfile`
- If 404 page returns 200: `handle_errors 404` block may be missing or misplaced in Caddyfile
- If chroma count is 0: `css/syntax.css` may not be linked or Goldmark may not be emitting Chroma classes — check `curl -s http://localhost:8080/articles/test-pipeline | grep class`
- If /templates/ returns 200 or 404: catch-all `handle { respond 403 }` may be missing or not last
  </action>
  <verify>
    All `echo` checks above produce expected output. No check shows an unexpected status code or missing header.
  </verify>
  <done>All 5 Phase 2 success criteria verified against localhost. Automated checks pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of Phase 2 success criteria via public URL</name>
  <action>Human verifies all five Phase 2 success criteria against the public URL https://fedora.mist-walleye.ts.net</action>
  <what-built>
Complete Phase 2 rendering pipeline:
- Caddyfile with content negotiation (Markdown vs HTML), Vary header, whitelist (403), 404 handler
- templates/article.html rendering YAML front matter (title, date) + Markdown body via Goldmark
- templates/404.html with "Back to articles" link
- css/syntax.css with Chroma github syntax highlighting
  </what-built>
  <how-to-verify>
Run these checks from your terminal against the public URL:

**1. HTML rendering (browser or curl):**
```bash
curl -s https://fedora.mist-walleye.ts.net/articles/test-pipeline | grep -E "<title>|<h1>|<time>"
```
Expected: lines showing `Pipeline Verification` and `2026-02-21`

Or open https://fedora.mist-walleye.ts.net/articles/test-pipeline in a browser — you should see a rendered page with title and date (unstyled is fine, Phase 3 adds CSS).

**2. Markdown content negotiation:**
```bash
curl -s -H "Accept: text/markdown" https://fedora.mist-walleye.ts.net/articles/test-pipeline
```
Expected: raw Markdown text (not HTML, no DOCTYPE)

**3. Vary: Accept header:**
```bash
curl -s -I https://fedora.mist-walleye.ts.net/articles/test-pipeline | grep -i vary
```
Expected: `Vary: Accept`

**4. 404 for missing article:**
```bash
curl -s -o /dev/null -w "%{http_code}" https://fedora.mist-walleye.ts.net/articles/no-such-article
```
Expected: `404`

**5. Syntax highlighting + /templates/ 403:**
```bash
# Syntax highlighting (chroma CSS classes in output)
curl -s https://fedora.mist-walleye.ts.net/articles/test-pipeline | grep -c "chroma"
# Expected: > 0

# /templates/ access control
curl -s -o /dev/null -w "%{http_code}" https://fedora.mist-walleye.ts.net/templates/
# Expected: 403
```
  </how-to-verify>
  <resume-signal>
Type "approved" if all 5 checks pass. Or describe any failures and Claude will fix them before marking the phase complete.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Clean up test article</name>
  <files>articles/test-pipeline.md</files>
  <action>
Remove the temporary verification article. Real content comes in Phase 4.

```bash
rm /home/elendal/IdeaProjects/blog/articles/test-pipeline.md
```

Verify it's gone:
```bash
ls /home/elendal/IdeaProjects/blog/articles/
# Should be empty (or only contain files from earlier phases)
```

Then verify the blog root still works without articles/index.md:
```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/
# Expected: 404 (index.md doesn't exist — this is correct, Phase 4 creates it)
# NOT 500 (which would indicate template error unrelated to missing file)
```
  </action>
  <verify>
    ```bash
    ls /home/elendal/IdeaProjects/blog/articles/
    # No test-pipeline.md present
    ```
  </verify>
  <done>Test article removed. Articles directory is clean.</done>
</task>

</tasks>

<verification>
Phase 2 complete when all five success criteria from ROADMAP.md are confirmed:
1. Browser request to article URL returns rendered HTML with title and date from YAML front matter
2. `curl -H "Accept: text/markdown"` returns raw Markdown (not HTML)
3. Responses include `Vary: Accept` header
4. Non-existent article returns HTTP 404 (not blank 200)
5. Code blocks display with syntax highlighting; direct requests to `/templates/` return HTTP 403

Verified against public URL: https://fedora.mist-walleye.ts.net
</verification>

<success_criteria>
- Human confirms all 5 Phase 2 success criteria via the checkpoint
- Test article cleaned up
- Phase 2 declared complete in STATE.md
</success_criteria>

<output>
After completion, create `.planning/phases/02-rendering-pipeline/02-03-SUMMARY.md` using the summary template.
Update STATE.md: Phase 2 complete, ready for Phase 3 (Styling and Metadata).
</output>
