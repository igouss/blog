---
phase: 02-rendering-pipeline
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/article.html
  - templates/404.html
  - css/syntax.css
autonomous: true
requirements: [REND-02, REND-03, REND-04, REND-05]

must_haves:
  truths:
    - "Browser request to /articles/my-post returns rendered HTML with <h1> title and <time> date from YAML front matter"
    - "Request to a non-existent article returns HTTP 404 with HTML page containing '← Back to articles' link"
    - "Code blocks in articles render with syntax highlighting (colored spans, not plain text)"
    - "css/syntax.css exists and contains Chroma github theme CSS rules"
  artifacts:
    - path: "templates/article.html"
      provides: "Caddy Go template rendering Markdown as HTML with front matter"
      contains: "splitFrontMatter"
    - path: "templates/404.html"
      provides: "404 error page with back-link, respects Accept header via handle_errors block in Caddyfile"
    - path: "css/syntax.css"
      provides: "Chroma github syntax highlighting CSS"
      contains: ".chroma"
  key_links:
    - from: "templates/article.html"
      to: "articles/{slug}.md"
      via: ".OriginalReq.URL.Path + fileExists guard"
      pattern: "OriginalReq.URL.Path"
    - from: "templates/article.html"
      to: "httpError 404"
      via: "fileExists guard — if file missing, abort with 404"
      pattern: "httpError 404"
    - from: "templates/article.html markdown action"
      to: "css/syntax.css"
      via: "Goldmark renders code fences; Chroma CSS provides styling"
      pattern: "markdown.*Body"
---

<objective>
Create the two Caddy Go templates (article.html and 404.html) and generate the Chroma syntax-highlighting CSS.

Purpose: Templates are the rendering layer. The Caddyfile (Plan 01) rewrites requests to these templates; without them, all HTML requests fail.
Output: templates/article.html, templates/404.html, css/syntax.css
</objective>

<execution_context>
@/home/elendal/.claude/get-shit-done/workflows/execute-plan.md
@/home/elendal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create article.html and 404.html Caddy templates</name>
  <files>templates/article.html, templates/404.html</files>
  <action>
Create two Caddy Go template files. These use Caddy's built-in template functions: `include`, `splitFrontMatter`, `markdown`, `fileExists`, `httpError`.

**templates/article.html** — renders any article including index:

```html
{{$origPath := .OriginalReq.URL.Path}}
{{$mdPath := ""}}
{{if or (eq $origPath "/") (eq $origPath "/articles/") (eq $origPath "/articles")}}
  {{$mdPath = "/articles/index.md"}}
{{else}}
  {{$mdPath = printf "%s.md" $origPath}}
{{end}}
{{if not (fileExists $mdPath)}}{{httpError 404}}{{end}}
{{$doc := include $mdPath | splitFrontMatter}}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{$doc.Meta.title}}</title>
  <link rel="stylesheet" href="/css/blog.css">
  <link rel="stylesheet" href="/css/syntax.css">
</head>
<body>
  <main>
    <article>
      <header>
        <h1>{{$doc.Meta.title}}</h1>
        <time datetime="{{$doc.Meta.date}}">{{$doc.Meta.date}}</time>
      </header>
      {{markdown $doc.Body}}
    </article>
  </main>
</body>
</html>
```

**templates/404.html** — served by `handle_errors 404` in Caddyfile (HTML branch only; Markdown branch uses `respond` directly):

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>404 Not Found</title>
  <link rel="stylesheet" href="/css/blog.css">
</head>
<body>
  <main>
    <article>
      <h1>404 Not Found</h1>
      <p>The article you requested does not exist.</p>
      <p><a href="/">&#8592; Back to articles</a></p>
    </article>
  </main>
</body>
</html>
```

**Implementation notes:**
- `.OriginalReq.URL.Path` is the path BEFORE Caddy's internal rewrite (critical — `.Req.URL.Path` would return `/templates/article.html` after rewrite). This is a locked research decision.
- `include` reads the file contents as a string; `splitFrontMatter` parses YAML front matter and returns `{Meta map, Body string}`.
- `{{markdown $doc.Body}}` renders the Markdown body via Goldmark (built into Caddy). This is an `untyped` template action — Caddy wraps the output in `template.HTML` to mark it safe.
- `{{if not (fileExists $mdPath)}}{{httpError 404}}{{end}}` aborts template execution and triggers `handle_errors 404` in the Caddyfile (which rewrites to templates/404.html). This satisfies REND-03.
- The `<link href="/css/blog.css">` will return 404 until Phase 3 creates the file — that's intentional (user decision: link now, avoid rework later).
- `css/syntax.css` IS linked from article.html but NOT from 404.html (user decision: no code blocks on 404 page).
- Use `&#8592;` for the ← arrow in 404.html (HTML entity, safe across encodings).
- Template files must be world-readable: `chmod a+r templates/article.html templates/404.html`

**After creating files:**
```bash
chmod a+r /home/elendal/IdeaProjects/blog/templates/article.html
chmod a+r /home/elendal/IdeaProjects/blog/templates/404.html
```
  </action>
  <verify>
    ```bash
    # Files exist and are readable
    ls -la /home/elendal/IdeaProjects/blog/templates/
    # Both article.html and 404.html should appear with a+r permissions

    # Quick syntax check: look for required template constructs
    grep -c "OriginalReq.URL.Path" /home/elendal/IdeaProjects/blog/templates/article.html
    # Must return 1

    grep -c "httpError 404" /home/elendal/IdeaProjects/blog/templates/article.html
    # Must return 1

    grep -c "splitFrontMatter" /home/elendal/IdeaProjects/blog/templates/article.html
    # Must return 1
    ```
  </verify>
  <done>
    - templates/article.html exists with world-read permissions, contains `OriginalReq.URL.Path`, `splitFrontMatter`, `httpError 404`, `markdown $doc.Body`
    - templates/404.html exists with world-read permissions, contains `← Back to articles` link to `/`, links to /css/blog.css only
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate Chroma syntax.css and verify end-to-end rendering</name>
  <files>css/syntax.css</files>
  <action>
Generate the Chroma github-theme CSS file and do a full end-to-end render test with a real article.

**Step 1: Generate Chroma CSS**

Caddy bundles Chroma internally and uses it via the `markdown` template action. However, generating the CSS file requires `hugo` (which has the same `gen chromastyles` subcommand):

```bash
which hugo && hugo gen chromastyles --style=github > /home/elendal/IdeaProjects/blog/css/syntax.css
```

If `hugo` is not installed:
```bash
sudo dnf install -y hugo
hugo gen chromastyles --style=github > /home/elendal/IdeaProjects/blog/css/syntax.css
```

After generating:
```bash
chmod a+r /home/elendal/IdeaProjects/blog/css/syntax.css
```

Verify the file was generated (should be non-empty, containing `.chroma` CSS rules):
```bash
wc -l /home/elendal/IdeaProjects/blog/css/syntax.css
# Expected: > 50 lines of CSS
head -5 /home/elendal/IdeaProjects/blog/css/syntax.css
# Expected: CSS comment or .chroma { ... } rule
```

**Step 2: Create a test article with front matter and a code block**

```bash
cat > /home/elendal/IdeaProjects/blog/articles/test.md << 'EOF'
---
title: Test Article
date: 2026-02-21
---

This is a test article to verify the rendering pipeline.

## Code Example

```python
def hello(name):
    return f"Hello, {name}!"

print(hello("world"))
```

End of test.
EOF
chmod a+r /home/elendal/IdeaProjects/blog/articles/test.md
```

**Step 3: End-to-end render test**

Test HTML rendering (template execution):
```bash
curl -s http://localhost:8080/articles/test
# Expected: Full HTML page with DOCTYPE, <title>Test Article</title>,
#           <h1>Test Article</h1>, <time>2026-02-21</time>,
#           and syntax-highlighted code block (span elements with class="chroma")
```

Test 404 handling:
```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/articles/nonexistent
# Expected: 404

curl -s http://localhost:8080/articles/nonexistent
# Expected: HTML with "404 Not Found" and "Back to articles" link
```

Test Markdown content negotiation still works:
```bash
curl -s -H "Accept: text/markdown" http://localhost:8080/articles/test
# Expected: raw Markdown content (the test.md file, not HTML)
```

**Step 4: Clean up test article** — real content comes in Phase 4
```bash
rm /home/elendal/IdeaProjects/blog/articles/test.md
```

**Troubleshooting:**
- If HTML renders but code block has no highlighting (just monospace), the Chroma CSS may not be linked or `.chroma` class may not be in the output. Check: `curl -s http://localhost:8080/articles/test | grep chroma`
- If template returns 500, check Caddy log: `caddy run --config configs/Caddyfile 2>&1 | head -50` (temporarily) — common cause: `splitFrontMatter` on a file with Windows line endings, or `include` path issue
- If `fileExists` guard misfires (always 404 even when file exists), the path construction is wrong — verify `.OriginalReq.URL.Path` value by temporarily echoing it: `{{.OriginalReq.URL.Path}}`
  </action>
  <verify>
    ```bash
    # CSS file exists and contains Chroma rules
    grep -c ".chroma" /home/elendal/IdeaProjects/blog/css/syntax.css
    # Must be > 0

    # Full render test (after creating test.md)
    curl -s http://localhost:8080/articles/test | grep -c "<h1>"
    # Must return 1 (title rendered as h1)

    curl -s http://localhost:8080/articles/test | grep "2026-02-21"
    # Must return the <time> element with the date

    curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/articles/nonexistent
    # Must return 404
    ```
  </verify>
  <done>
    - css/syntax.css exists, is non-empty, contains `.chroma` CSS rules, is world-readable
    - `curl http://localhost:8080/articles/test` returns full HTML with rendered title, date, and Chroma-highlighted code block
    - `curl http://localhost:8080/articles/nonexistent` returns HTTP 404 with HTML 404 page
    - Test article cleaned up
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `ls templates/` shows article.html and 404.html
2. `ls css/` shows syntax.css (non-empty, contains .chroma rules)
3. `curl -s http://localhost:8080/articles/test` (with test.md temporarily in place) returns DOCTYPE HTML with `<title>Test Article</title>`, `<h1>Test Article</h1>`, `<time>2026-02-21</time>`, and Chroma-highlighted code
4. `curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/articles/nonexistent` returns 404
5. `curl -s http://localhost:8080/articles/nonexistent` returns HTML with "Back to articles" link
</verification>

<success_criteria>
- REND-02: article.html reads Markdown via `.OriginalReq.URL.Path` and renders via Goldmark (`markdown $doc.Body`)
- REND-03: `{{if not (fileExists $mdPath)}}{{httpError 404}}{{end}}` guard returns proper HTTP 404 for missing articles
- REND-04: article.html displays `$doc.Meta.title` in `<h1>` and `$doc.Meta.date` in `<time>` element
- REND-05: css/syntax.css generated with Chroma github theme; code blocks receive `.chroma` styled spans
</success_criteria>

<output>
After completion, create `.planning/phases/02-rendering-pipeline/02-02-SUMMARY.md` using the summary template.
Key things to capture: exact hugo version used for Chroma CSS generation, whether `splitFrontMatter` worked with YAML front matter as expected, any template syntax issues, and Caddy version confirmed in use.
</output>
