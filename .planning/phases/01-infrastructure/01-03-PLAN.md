---
phase: 01-infrastructure
plan: 03
type: execute
wave: 3
depends_on:
  - "01-02"
files_modified: []
autonomous: false
requirements:
  - INFRA-04
  - INFRA-05

must_haves:
  truths:
    - "tailscale funnel is active and routing public internet TCP traffic to localhost:443"
    - "A browser or curl from outside the tailnet receives HTTP 200 over HTTPS from fedora.mist-walleye.ts.net"
    - "TLS certificate is valid — no browser warning — when accessed from outside the tailnet"
  artifacts:
    - path: "tailscale funnel status"
      provides: "Persistent Funnel rule forwarding port 443 to localhost:443"
  key_links:
    - from: "public internet"
      to: "tailscaled on fedora.mist-walleye.ts.net"
      via: "Tailscale Funnel relay (SNI TCP proxy)"
      pattern: "tailscale funnel.*--tls-terminated-tcp=443"
    - from: "tailscaled"
      to: "Caddy on localhost:443"
      via: "--tls-terminated-tcp=443 raw TCP forward"
      pattern: "tcp://localhost:443"

user_setup:
  - service: tailscale-admin-console
    why: "Tailscale Funnel requires nodeAttrs funnel in the tailnet ACL policy. If not already enabled, the tailscale funnel command will prompt for admin console action."
    dashboard_config:
      - task: "Enable Funnel in tailnet ACL policy"
        location: "Tailscale admin console → Access controls → Edit policy — add: {\"nodeAttrs\": [{\"target\": [\"autogroup:member\"], \"attr\": [\"funnel\"]}]}"
---

<objective>
Expose the blog to the public internet via Tailscale Funnel and verify end-to-end HTTPS access from outside the tailnet.

Purpose: This is the final Phase 1 milestone — turning a tailnet-only HTTPS endpoint into a publicly reachable blog. Funnel acts as an SNI-aware TCP proxy: it does NOT terminate TLS; it forwards raw TCP to Caddy on localhost:443, where Caddy terminates TLS using the Tailscale cert.

Output: Active Funnel rule persisting across reboots; confirmed HTTP 200 from external device.
</objective>

<execution_context>
@/home/elendal/.claude/get-shit-done/workflows/execute-plan.md
@/home/elendal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable Tailscale Funnel on port 443</name>
  <files></files>
  <action>
Enable Tailscale Funnel to forward public internet traffic to Caddy on localhost:443.

```bash
# Enable Funnel — --bg makes it persist across reboots and terminal exit
# --tls-terminated-tcp=443: forward raw TCP; Caddy terminates TLS (NOT --https=443)
tailscale funnel --bg --tls-terminated-tcp=443 tcp://localhost:443
```

CRITICAL: Use `--tls-terminated-tcp=443`, NOT `--https=443`.
- `--tls-terminated-tcp=443`: Funnel forwards raw encrypted TCP → Caddy terminates TLS using Tailscale cert. Correct.
- `--https=443`: Funnel terminates TLS and forwards plain HTTP → conflicts with Caddy's TLS stack. Wrong.

If the command outputs a link to the Tailscale admin console, the tailnet ACL policy is missing the `funnel` nodeAttr. In that case:
1. Go to the admin console URL provided
2. Edit the policy JSON to add: `{"nodeAttrs": [{"target": ["autogroup:member"], "attr": ["funnel"]}]}`
3. Save the policy
4. Re-run the `tailscale funnel` command

After enabling, verify the Funnel rule is active:
```bash
tailscale funnel status
# Expected output shows: fedora.mist-walleye.ts.net:443 -> tcp://localhost:443
```

Source: https://tailscale.com/kb/1311/tailscale-funnel
  </action>
  <verify>
```bash
tailscale funnel status
# Expected: shows an active rule for port 443 forwarding to tcp://localhost:443
# No "not configured" or "error" output
```
  </verify>
  <done>tailscale funnel status shows an active rule: fedora.mist-walleye.ts.net port 443 forwarded to tcp://localhost:443 via --tls-terminated-tcp mode.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify external HTTPS access from outside the tailnet</name>
  <files></files>
  <action>
What was built: Tailscale Funnel is active (Task 1 confirmed via `tailscale funnel status`). Caddy is serving HTTPS with a Tailscale-issued *.ts.net cert (Plan 02). The full stack should now be publicly reachable.

From a device OUTSIDE the tailnet (mobile phone on cellular data, a VPS, or any device not connected to the mist-walleye tailnet):

1. Open a browser and navigate to: https://fedora.mist-walleye.ts.net
   - Expected: Page loads with "Blog coming soon" — no TLS warning, no connection refused

2. OR run curl from an external device or online tool:
   ```
   curl -I https://fedora.mist-walleye.ts.net
   ```
   Expected response:
   ```
   HTTP/2 200
   server: Caddy
   ```

If this fails:
- From the Fedora host, confirm Funnel is active: `tailscale funnel status`
- Confirm Caddy is up: `sudo systemctl is-active caddy`
- Check Caddy logs: `journalctl -u caddy -n 30 --no-pager`
- Confirm no firewall is blocking 443: `sudo firewall-cmd --list-all` (if firewalld is active)
  </action>
  <verify>
Human confirms: https://fedora.mist-walleye.ts.net loads from outside the tailnet with no TLS warning and returns HTTP 200.

Resume signal: Type "approved" if https://fedora.mist-walleye.ts.net loads correctly from outside the tailnet. Describe any issues if it does not.
  </verify>
  <done>User confirms external HTTPS access — browser or curl from outside the tailnet receives HTTP 200 with no TLS warning.</done>
</task>

</tasks>

<verification>
After human confirmation:

```bash
# Funnel persists
tailscale funnel status

# Caddy still running
sudo systemctl is-active caddy

# (From host, within tailnet — smoke test only; external access is the real gate)
curl -o /dev/null -s -w "%{http_code}\n" https://fedora.mist-walleye.ts.net
# Expected: 200
```

All four Phase 1 success criteria should now be met:
1. Repository directory structure exists in /srv/blog
2. Caddy serves HTTPS using *.ts.net cert from Tailscale (no browser TLS warning)
3. Tailscale Funnel is active and routing public internet traffic to Caddy on port 443
4. External browser receives HTTP 200 over HTTPS
</verification>

<success_criteria>
- tailscale funnel status shows active rule for port 443 → tcp://localhost:443
- https://fedora.mist-walleye.ts.net returns HTTP 200 from a device outside the tailnet
- TLS cert is Tailscale-issued *.ts.net — no browser TLS warning
- User has confirmed external access via the checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-03-SUMMARY.md` with the funnel status output, the external verification result (HTTP response or browser screenshot description), and confirmation of all four Phase 1 success criteria.
</output>
