---
phase: 02-rendering-pipeline
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - configs/Caddyfile
autonomous: true
requirements: [REND-01, REND-06, REND-07, STYL-04]

must_haves:
  truths:
    - "curl -H 'Accept: text/markdown' https://fedora.mist-walleye.ts.net/articles/my-post returns raw Markdown with Content-Type text/markdown"
    - "curl https://fedora.mist-walleye.ts.net/articles/my-post returns HTML (Caddy rewrites and executes template)"
    - "curl -I https://fedora.mist-walleye.ts.net/articles/my-post includes Vary: Accept header"
    - "curl -s -o /dev/null -w '%{http_code}' https://fedora.mist-walleye.ts.net/templates/ returns 403"
    - "curl -s -o /dev/null -w '%{http_code}' https://fedora.mist-walleye.ts.net/configs/ returns 403"
    - "curl -s -o /dev/null -w '%{http_code}' https://fedora.mist-walleye.ts.net/css/blog.css returns 200 or 404 (not 403)"
  artifacts:
    - path: "configs/Caddyfile"
      provides: "Caddy routing with content negotiation, whitelist, 404 handler"
      contains: "handle @articleSlug"
  key_links:
    - from: "configs/Caddyfile @wantsMarkdown matcher"
      to: "file_server serving raw .md"
      via: "handle block with header Content-Type text/markdown"
      pattern: "header Content-Type.*text/markdown"
    - from: "configs/Caddyfile @articleSlug handle"
      to: "templates/article.html"
      via: "rewrite + templates directive"
      pattern: "rewrite.*templates/article.html"
    - from: "configs/Caddyfile handle_errors 404"
      to: "templates/404.html"
      via: "rewrite + templates directive"
      pattern: "rewrite.*templates/404.html"
---

<objective>
Rewrite configs/Caddyfile with Phase 2 content negotiation routing: clean URL rewrites, Markdown vs HTML content negotiation, Vary header, whitelist access control (403 for non-whitelisted paths), and 404 error handling.

Purpose: The Caddyfile is the routing layer. Without it, no content negotiation or access control exists.
Output: Updated configs/Caddyfile with full Phase 2 routing; caddy reloaded and serving new config.
</objective>

<execution_context>
@/home/elendal/.claude/get-shit-done/workflows/execute-plan.md
@/home/elendal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Phase 2 Caddyfile with content negotiation and whitelist</name>
  <files>configs/Caddyfile</files>
  <action>
Replace the current minimal Phase 1 Caddyfile (`configs/Caddyfile`) with the Phase 2 config. The repo root is `/home/elendal/IdeaProjects/blog`.

Write the following Caddyfile verbatim (then run `caddy fmt --overwrite configs/Caddyfile` to canonicalize):

```caddyfile
:8080 {
    root * /home/elendal/IdeaProjects/blog

    # Named matchers
    @articleSlug path_regexp article ^/articles/([^/]+)$
    @articleIndex path /articles/ /articles
    @root path /

    # Blog root — serves articles/index.md
    handle @root {
        header +Vary "Accept"
        @rootMarkdown header Accept *text/markdown*
        handle @rootMarkdown {
            header Content-Type "text/markdown; charset=utf-8"
            rewrite * /articles/index.md
            file_server
        }
        handle {
            rewrite * /templates/article.html
            templates
            file_server
        }
    }

    # /articles/ and /articles index
    handle @articleIndex {
        header +Vary "Accept"
        @idxMarkdown header Accept *text/markdown*
        handle @idxMarkdown {
            header Content-Type "text/markdown; charset=utf-8"
            rewrite * /articles/index.md
            file_server
        }
        handle {
            rewrite * /templates/article.html
            templates
            file_server
        }
    }

    # /articles/{slug} — slug must not contain /
    handle @articleSlug {
        header +Vary "Accept"
        @slugMarkdown header Accept *text/markdown*
        handle @slugMarkdown {
            header Content-Type "text/markdown; charset=utf-8"
            rewrite * /articles/{re.article.1}.md
            file_server
        }
        handle {
            rewrite * /templates/article.html
            templates
            file_server
        }
    }

    # Whitelisted static directories
    handle /css/* {
        file_server
    }
    handle /images/* {
        file_server
    }
    handle /scripts/* {
        file_server
    }

    # Custom 404 error handler
    handle_errors 404 {
        @404markdown header Accept *text/markdown*
        handle @404markdown {
            header Content-Type "text/markdown; charset=utf-8"
            respond "# 404 Not Found\n\nThe article you requested does not exist.\n\n[← Back to articles](/)" 404
        }
        handle {
            rewrite * /templates/404.html
            templates
            file_server
        }
    }

    # Catch-all: 403 for everything not whitelisted above
    handle {
        respond 403
    }
}
```

**Critical implementation notes:**
- `path_regexp article` names the regexp group `article` — the capture group `{re.article.1}` expands to the slug in the rewrite. If `caddy adapt` rejects this syntax, test with `caddy adapt --config configs/Caddyfile` to confirm.
- `header +Vary "Accept"` appends the header (does not overwrite). Use `+Vary` not `Vary`.
- Nested `handle` blocks at the same nesting level are mutually exclusive — first match wins. `@slugMarkdown` inside `handle @articleSlug` is scoped to that block.
- The catch-all `handle` at the bottom must be last — it fires for anything not matched above (templates/, configs/, idea.txt, etc.).
- The `handle_errors 404` block only fires when a 404 status is produced upstream (e.g., `httpError 404` from a template, or file_server failing to find a file). It does NOT fire for the catch-all `respond 403`.
  </action>
  <verify>
    Run: `caddy adapt --config /home/elendal/IdeaProjects/blog/configs/Caddyfile`
    Expected: Outputs valid JSON Caddy config with no errors. If it errors, fix the syntax issue — common causes: `path_regexp` capture group syntax, nested named matchers inside handle blocks.
    Also run: `caddy fmt --overwrite /home/elendal/IdeaProjects/blog/configs/Caddyfile` to canonicalize tabs/formatting.
  </verify>
  <done>`caddy adapt` exits 0 and outputs JSON config. Caddyfile is formatted with tabs (caddy fmt applied).</done>
</task>

<task type="auto">
  <name>Task 2: Reload Caddy with new config and smoke-test routing</name>
  <files></files>
  <action>
Reload Caddy with the new Phase 2 config and run smoke tests against localhost to verify basic routing works before templates exist.

**Step 1: Reload Caddy**
```bash
caddy reload --config /home/elendal/IdeaProjects/blog/configs/Caddyfile
```
If this fails (Caddy not running), start it:
```bash
caddy start --config /home/elendal/IdeaProjects/blog/configs/Caddyfile
```

**Step 2: Smoke-test whitelist access control**
The catch-all `handle { respond 403 }` should fire for non-whitelisted paths. Test:
```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/templates/
# Expected: 403 (not 200 or 404)

curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/configs/
# Expected: 403

curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/idea.txt
# Expected: 403
```

**Step 3: Smoke-test Markdown content negotiation (raw file serving)**
Before templates exist, test that the Markdown branch serves the raw `.md` file. Create a test article first:
```bash
cat > /home/elendal/IdeaProjects/blog/articles/test.md << 'EOF'
---
title: Test Article
date: 2026-02-21
---

# Test Article

This is a test.
EOF
```

Then test:
```bash
curl -s -H "Accept: text/markdown" http://localhost:8080/articles/test
# Expected: raw Markdown content returned (the test.md file contents)

curl -s -I -H "Accept: text/markdown" http://localhost:8080/articles/test
# Expected: Content-Type: text/markdown; charset=utf-8
# Expected: Vary: Accept header present
```

**Step 4: Smoke-test HTML branch (templates not yet created)**
```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/articles/test
# Expected: 500 (templates/article.html doesn't exist yet) OR 200 if somehow resolves
# This is OK — templates will be created in Plan 02
# If it returns 403, the routing is broken — debug.
```

**Step 5: Remove test article** (Plan 04 creates real content)
```bash
rm /home/elendal/IdeaProjects/blog/articles/test.md
```

**If capture group rewrite fails:** The `{re.article.1}` syntax must expand the regexp named group. If `curl -H "Accept: text/markdown" http://localhost:8080/articles/test` returns the wrong file or 404, run `caddy adapt` and inspect the JSON to confirm the rewrite rule. Alternative syntax if needed: use `path_regexp` without a name and reference `{re.1}`.
  </action>
  <verify>
    ```bash
    curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/templates/
    # Must return 403

    curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/configs/
    # Must return 403

    curl -s -H "Accept: text/markdown" http://localhost:8080/articles/test
    # Must return raw Markdown (after creating test.md temporarily)
    ```
  </verify>
  <done>
    - `/templates/` returns HTTP 403
    - `/configs/` returns HTTP 403
    - `Accept: text/markdown` requests to article URLs return raw Markdown with `Content-Type: text/markdown`
    - `Vary: Accept` header present on article responses
    - Caddy is running and serving the Phase 2 config
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `caddy adapt --config /home/elendal/IdeaProjects/blog/configs/Caddyfile` exits 0 (valid config)
2. `curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/templates/` returns 403
3. `curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/configs/` returns 403
4. Content negotiation: Markdown branch serves raw .md files correctly (verified with temp test article)
5. `Vary: Accept` present in response headers for article URLs
</verification>

<success_criteria>
- REND-01: Caddy rewrites article URLs to `templates/article.html` for HTML requests (non-markdown Accept)
- REND-06: Caddy serves raw Markdown to `Accept: text/markdown` clients without HTML
- REND-07: `Vary: Accept` header present on all article responses
- STYL-04: `/templates/` returns 403; all non-whitelisted paths return 403 via catch-all handler
</success_criteria>

<output>
After completion, create `.planning/phases/02-rendering-pipeline/02-01-SUMMARY.md` using the summary template.
Key things to capture: whether `{re.article.1}` capture group syntax worked, any Caddyfile syntax issues encountered, exact caddy version, and whether nested named matchers inside handle blocks worked as expected.
</output>
